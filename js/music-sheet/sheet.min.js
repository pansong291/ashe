(function(a){function c(a,b){if(!(a instanceof b))throw TypeError("Called as a function. Did you forget 'new'?")}function d(a){throw RangeError("\u672A\u77E5\u683C\u5F0F: "+a)}function e(d=1,a=1){if(c(this,e),!Number.isInteger(d)||!Number.isInteger(a))throw RangeError("\u5206\u5B50\u5206\u6BCD\u5FC5\u987B\u4E3A\u6574\u6570");if(!a)throw RangeError("\u5206\u6BCD\u4E0D\u80FD\u4E3A 0");this.a=d,this.b=a,this.simplify=function(){let a=Math.max(this.a,this.b),b=Math.min(this.a,this.b);for(;b;){const c=b;b=a%b,a=c}return this.a/=a,this.b/=a,this}}function f(a,b=[]){c(this,f),this.rate=a,this.tones=b}function g(a="",b="",d="",e=0,f=0,h=[]){c(this,g),this.name=a,this.author=b,this.transcribedBy=d,this.keyNote=e,this.bpm=f,this.beats=h}function h(a=[],b=0){c(this,h),this.locations=a,this.postDelay=b}function i(a=[],b=0,d=!1){c(this,i),this.keys=a,this.keyOffset=b,this.semitone=d}function j(a){c(this,j);const b=o[a];b||d(a),this.format=b(),this.label=a}function k(a){c(this,k);const b=p[a];b||d(a),this.parse=b(),this.label=a}const l={CHAR_A:65,CHAR_0:48,groupBy(a,b){const c={};return a.forEach(a=>{const d=b(a);c[d]||(c[d]=[]),c[d].push(a)}),c},insertionSort(a,b){let c,d,e,f=a.length;for(c=1;c<f;c++){for(e=a[c],d=c-1;0<=d&&!b(a[d],e);)a[d+1]=a[d],--d;a[d+1]=e}}},m={missingKeyException:"MissingKeyException",semitones:[1,3,6,8,10],naturals:[0,2,4,5,7,9,11],isSemitone(a){let b=a%12;return 0>b&&(b+=12),this.semitones.includes(b)},isNatural(a){let b=a%12;return 0>b&&(b+=12),this.naturals.includes(b)},basicNoteTo12TET(a){let b=Math.sign(a)*Math.floor(Math.abs(a)/7),c=a%7;return 0>c&&(c+=7,b--),c=this.naturals[c],c+12*b},tet12ToBasicNote(a){let b=Math.sign(a)*Math.floor(Math.abs(a)/12),c=a%12;0>c&&(c+=12,b--);const d=this.naturals.indexOf(c);if(0>d)throw RangeError("\u534A\u97F3\u65E0\u6CD5\u8F6C\u4E3A\u57FA\u672C\u97F3\u7EA7");return d+7*b},findSuitableOffset(a,b){let c=NaN,d=NaN,e=NaN,f=NaN;const g=b.keys.map((a,e)=>{let f=e+b.keyOffset;return b.semitone||(f=this.basicNoteTo12TET(f)),(isNaN(c)||f<c)&&(c=f),(isNaN(d)||f>d)&&(d=f),f}),h=a.beats.flatMap(b=>b.tones.map(b=>{const c=b+a.keyNote;return(isNaN(e)||c<e)&&(e=c),(isNaN(f)||c>f)&&(f=c),c}));if(isNaN(c))throw Error(this.missingKeyException);if(isNaN(e))return 0;const i=c-e,j=d-f;let k=Math.max(0,i);for(;k<=j;){if(h.every(a=>g.includes(a+k)))return k;k++}for(k=Math.min(-1,j);k>=i;){if(h.every(a=>g.includes(a+k)))return k;k--}throw Error(this.missingKeyException)},createHitActions(a,b){const c=this.findSuitableOffset(a,b),d=Object.create(null),e=6e4/a.bpm;for(let c,e=0;e<b.keys.length;e++)c=e+b.keyOffset,b.semitone||(c=this.basicNoteTo12TET(c)),d[c]=e;return a.beats.map(b=>{const f=b.tones.map(b=>{const e=d[b+a.keyNote+c];if(void 0===e||null===e)throw Error(this.missingKeyException);return e}),g=Math.floor(b.rate.a*e/b.rate.b);return new h(f,g)})}},n={checkPitchLevel(a){if(!Number.isInteger(a))throw TypeError("pitchLevel \u5FC5\u987B\u4E3A\u6574\u6570");if(0>a||11<a)throw RangeError("pitchLevel \u8D85\u51FA\u8303\u56F4 [0, 11]");return a},checkBpm(a){if(!Number.isInteger(a))throw TypeError("bpm \u5FC5\u987B\u4E3A\u6574\u6570");if(!a||0>=a)throw RangeError("bpm \u5FC5\u987B\u5927\u4E8E 0");return a}},o=Object.create(null),p=Object.create(null);o["sky-studio-json"]=()=>{const a=new i(Array.from(Array(15).keys()));return function(b){const c=m.createHitActions(b,a);let d=0;const e={name:b.name,author:b.author,transcribedBy:b.transcribedBy,bitsPerPage:16,pitchLevel:b.keyNote%12,bpm:b.bpm,songNotes:c.flatMap(a=>{const b=a.locations.sort((c,a)=>a-c).map((a,b)=>({time:d,key:`${b?2:1}Key${a}`}));return d+=a.postDelay,b})};return JSON.stringify([e])}},o["sky-studio-abc"]=()=>function(a){let b=1;a.beats.forEach(a=>{b*=new e(a.rate.a*b,a.rate.b).simplify().b});const c=a.bpm*b;if(!Number.isSafeInteger(c))throw EvalError("\u4E0D\u5B89\u5168\u7684\u8F6C\u6362");let d=`<DontCopyThisLine> ${c} ${a.keyNote%12} ${16} ${a.author} ${a.transcribedBy}`,f="";return a.beats.forEach(a=>{const c=new e(a.rate.a*b,a.rate.b).simplify().a-1;0>c||(a.tones.length?(a.tones.forEach(a=>{const b=m.tet12ToBasicNote(a);if(0>b||14<b)throw RangeError("\u65E0\u6CD5\u8F6C\u6362\u7684\u97F3\u7B26: "+b);f+=String.fromCharCode(Math.floor(b/5)+65)+(b%5+1)}),f+=" ",c&&(f+=". ".repeat(c))):f+=". ".repeat(c+1))}),d+"\n"+f},o["fengxu-genshin-2"]=()=>{const a=new i(["C2","D2","E2","F2","G2","A3","B3","C3","D3","E3","F3","G3","A4","B4","C4","D4","E4","F4","G4","A5","B5"].map(a=>`{${a}}`),-7);return function(b){const c=m.createHitActions(b,a);let d="";return c.forEach(b=>{b.locations.forEach(b=>{d+=a.keys[b]}),d+=b.locations.length?`<${b.postDelay}>`:b.postDelay+" "}),`parseGenshinImpactMusic("${b.name}", "${d}", 2)\n`}},o["piano-wizard-yp"]=()=>{const a={compileNote(a){let b=Math.sign(a)*Math.floor(Math.abs(a)/12),c=a%12;0>c&&(c+=12,b--);const d=m.isSemitone(c);d&&c--;const e=m.naturals.indexOf(c)+1;if(0>=e)return"0";let f=e+"";return 1==b?f+="+":-1===b?f+="-":0<b?f+="+"+b:0>b&&(f+=b),d&&(f+="#"),f},formatBeat(c){let d=c.tones.map(a=>this.compileNote(a)).join("&")||"0";const{a:e,b:a}=c.rate.simplify();return 0<e?(1!==e&&(d+="*"+e),1!==a&&(d+="/"+a),d+","):""}};return function(b){const c=b.keyNote%12,d=m.isSemitone(c),e=m.naturals.indexOf(d?c-1:c);let f=String.fromCharCode(5>e?67+e:60+e);d&&(f+="#");let g=`/**\n * name: ${b.name}\n * author: ${b.author}\n * arrangedBy: \n * transcribedBy: ${b.transcribedBy}\n */\n[1=${f},4/4,${b.bpm}]\n`;return b.beats.forEach(b=>{g+=a.formatBeat(b)}),g}},p["sky-studio-json"]=()=>{const a={checkSkyJSON(a){const b=JSON.parse(a);if(!Array.isArray(b))throw TypeError("\u683C\u5F0F\u9519\u8BEF");const c=b[0];if(!c)throw RangeError("\u6587\u4EF6\u5185\u5BB9\u4E3A\u7A7A");if(c.isEncrypted)throw RangeError("\u4E0D\u652F\u6301\u52A0\u5BC6\u7684 json \u6587\u4EF6");return c},checkSongNotes(a){if(!Array.isArray(a))throw TypeError("songNotes \u5FC5\u987B\u4E3A\u6570\u7EC4");return a},checkNoteTime(a){if(!Number.isInteger(a))throw TypeError("time \u5FC5\u987B\u4E3A\u6574\u6570");if(0>a)throw RangeError("time \u5FC5\u987B\u5927\u4E8E\u7B49\u4E8E 0");return a},checkKeyIndex(a){const b=parseInt(a);if(0<=b&&15>b)return b;throw RangeError("\u672A\u77E5\u952E\u4F4D: "+a)}};return function(b){const c=a.checkSkyJSON(b),d=new g(c.name||"Unknown",c.author||"",c.transcribedBy||"",n.checkPitchLevel(c.pitchLevel),n.checkBpm(c.bpm)),h=a.checkSongNotes(c.songNotes),i=Object.values(l.groupBy(h,b=>a.checkNoteTime(b.time))).map(b=>({time:b[0].time,keys:b.map(b=>a.checkKeyIndex(b.key.split("Key")[1]))}));l.insertionSort(i,(c,a)=>c.time<a.time);let j=new f(new e(0,6e4));return i.forEach(a=>{j.rate.a=(a.time-j.rate.a)*d.bpm,j.rate.a&&d.beats.push(j),j=new f(new e(a.time,j.rate.b),a.keys.map(a=>m.basicNoteTo12TET(a)))}),j.rate.a=4,j.rate.b=1,d.beats.push(j),d}},p["sky-studio-abc"]=()=>{const a={checkLines(a){if(a=a?.trim().replaceAll("\r\n","\n").replaceAll("\r","\n"),!a)throw SyntaxError("\u6587\u4EF6\u5185\u5BB9\u4E3A\u7A7A");if(0>a.indexOf("<DontCopyThisLine>"))throw SyntaxError("\u8BED\u6CD5\u683C\u5F0F\u9519\u8BEF");const b=a.indexOf(">"),c=a.indexOf("\n",b);if(0>c)throw SyntaxError("\u7F3A\u5931\u6362\u884C\u7B26 '\\n'");const d=a.substring(b+1,c).trim(),e=a.substring(c+1);return[d,e]},parseInfo(a){const b=a.split(" ").filter(a=>a),c=n.checkBpm(parseInt(b[0])),d=n.checkPitchLevel(parseInt(b[1]));return new g("",b[3],b[4],d,c)},parseKeys(a,b,c,d){let e=-1;for(;b<a.length;b++){const f=a.charAt(b);if(!(0>e))"1"<=f&&"5">=f?(c(5*e+f.charCodeAt(0)-l.CHAR_0-1),e=-1):("A"<=f&&"C">=f&&b--,d(b));else if("A"<=f&&"C">=f)e=f.charCodeAt(0)-l.CHAR_A;else{b--;break}}return 0<=e&&d(b-1),b},transferNotes(a,b,c){const d=a.length?c+1:c;d&&b.push(new f(new e(d),a.splice(0,a.length)))},errorAt(a,b,c){throw SyntaxError(`解析错误 (行: ${a}, 列: ${b}, 字符: ${c})`)}};return function(b){const[c,d]=a.checkLines(b),e=a.parseInfo(c);let f=0;const g=[];let h=2,j=-1;for(let c=0;c<d.length;c++){const b=d.charAt(c);" "!==b&&("\n"===b?(j=c,h++):"."===b?f++:"A"<=b&&"C">=b?(a.transferNotes(g,e.beats,f),f=0,c=a.parseKeys(d,c,a=>{g.push(m.basicNoteTo12TET(a))},b=>{a.errorAt(h,b-j,d.charAt(b))})):a.errorAt(h,c-j,d.charAt(c)))}return g.length&&a.transferNotes(g,e.beats,Math.max(f,3)),e}},p["fengxu-genshin-2"]=()=>{function a(a,c,d){if(2!==d)throw RangeError("\u7248\u672C\u9519\u8BEF");const h=[];let i=0,j={keys:[],start:0,wait:0,hold:0},k=!1;for(let e=0;e<c.length;e++){const a=c.charAt(e);a.trim()&&("{"===a?(e=b.parseKeys(c,e,a=>{(j.keys.length||j.wait)&&h.push(j),j={keys:a,start:i,wait:0,hold:0}}),k=!0):"<"===a?(!k&&b.errorAt(e),e=b.parseTime(c,e,"<",">",a=>{j.hold+=a,j.wait+=a,i+=a}),k=!1):"("===a?(!k&&b.errorAt(e),e=b.parseTime(c,e,"(",")",a=>{j.hold+=a}),k=!1):"0"<=a&&"9">=a?(e=b.parseNum(c,e,a=>{j.wait+=a,i+=a}),k=!1):b.errorAt(e))}if(h.push(j),!h.length)throw RangeError("\u5185\u5BB9\u4E3A\u7A7A");const m=Object.values(l.groupBy(h,a=>a.start)).flatMap(a=>{const b=a.flatMap(a=>a.keys),c=a[0].start,d=a.reduce((c,a)=>Math.max(c,a.wait),0),e=a.reduce((c,a)=>Math.max(c,a.hold),0);return b.length&&d>e&&e?[{keys:b,start:c,time:e},{keys:[],start:c+e,time:d-e}]:{keys:b,start:c,time:d}});l.insertionSort(m,(c,a)=>c.start<a.start);let n=0;m.forEach(a=>{(!n||a.time<n)&&a.time&&(n=a.time)});const o=m.map(a=>new f(new e(a.time||4*n,n),a.keys));b.result=new g,b.result.name=a,b.result.bpm=Math.floor(6e4/n),b.result.beats=o}const b={funcName:"parseGenshinImpactMusic",result:new g,parseKeyByName(a){if(a?.length){if(2===a.length){let b=a.charCodeAt(0)-l.CHAR_A;if(0>b||6<b)return;b-=2,0>b&&(b+=7);let c=a.charCodeAt(1)-l.CHAR_0;return 0>c||9<c?void 0:(c-=4,5>b&&c++,m.basicNoteTo12TET(b)+12*c)}if(4===a.length){const b=this.parseKeyByName(a.substring(0,2))+1,c=this.parseKeyByName(a.substring(2))-1;if(b===c)return b}}},parseKeys(a,b,c){let d=[],e=!1,f="";for(;b<a.length;b++){const c=a.charAt(b);if(e){if("}"===c){e=!1;const a=this.parseKeyByName(f);void 0===a?this.errorAt(b):d.push(a),f=""}else"A"<=c&&"G">=c||"0"<=c&&"9">=c?f+=c:this.errorAt(b);}else if("{"===c)e=!0;else{b--;break}}return e&&this.errorAt(b-1),c(d),b},parseTime(a,c,d,e,f){let g=0,h=!1;for(;c<a.length;c++){const i=a.charAt(c);if(!h)i===d?h=!0:b.errorAt(c);else if(i===e){g||b.errorAt(c),h=!1,f(g);break}else"0"<=i&&"9">=i?g=10*g+i.charCodeAt(0)-l.CHAR_0:b.errorAt(c)}return h&&b.errorAt(c-1),c},parseNum(a,b,c){let d=0;for(;b<a.length;b++){const c=a.charCodeAt(b)-l.CHAR_0;if(0<=c&&9>=c)d=10*d+c;else{b--;break}}return c(d),b},errorAt(a){throw SyntaxError(`解析错误 (位置: ${a})`)}};return function(c){if(0>c.indexOf(b.funcName))throw SyntaxError("\u8BED\u6CD5\u683C\u5F0F\u9519\u8BEF");const d=new Function(b.funcName,c);return d.call(null,a),b.result}},p["piano-wizard-yp"]=()=>{const a={blockCommentRegex:/\/\*[\d\D]*?\*\//g,lineCommentRegex:/\/\/[^\n]*/g,spaceCharRegex:/\s+/g,musicSyntaxRegex:/^\[1=([A-G][#b]?),\d+\/\d+,(\d+)](\d(?:[-+#b]\d*)*(?:&\d(?:[-+#b]\d*)*)*(?:[*/]\d+)*(?:,\d(?:[-+#b]\d*)*(?:&\d(?:[-+#b]\d*)*)*(?:[*/]\d+)*)*),?$/,musicBeatRegex:/^([^*/]+)((?:[*/]\d+)*)$/,startsWithNumberRegex:/^(\d+)?(.*)$/,removeComment(a){return a.replaceAll(this.blockCommentRegex,"").replaceAll(this.lineCommentRegex,"").replaceAll(this.spaceCharRegex,"")},checkMusicSyntax(a){const b=a.match(this.musicSyntaxRegex);if(!b||4>b.length)throw SyntaxError("\u8BED\u6CD5\u683C\u5F0F\u9519\u8BEF");return{keyNote:b[1],bpm:parseInt(b[2]),beats:b[3]}},parseBeat(a){const b=a.match(this.musicBeatRegex);if(!b||3>b.length)throw SyntaxError("\u8282\u62CD\u8BED\u6CD5\u683C\u5F0F\u9519\u8BEF");const c=new Set(b[1].split("&").map(a=>this.parseNote(a)).filter(a=>null!==a));return new f(this.parseRate(b[2],new e),Array.from(c))},parseRate(a,b){if(!a)return b;const c=a.substring(1).match(this.startsWithNumberRegex),d=parseInt(c?.[1]);if(0<d){const f="/"===a[0]?new e(b.a,b.b*d):new e(b.a*d,b.b);return this.parseRate(c[2],f)}throw RangeError("\u4E0D\u652F\u6301\u7684\u500D\u7387\u503C: "+a)},parseNote(a){const b=parseInt(a[0]);if(0<=b&&7>=b)return b?m.basicNoteTo12TET(b-1)+this.parseAccidental(a.substring(1),0):null;throw RangeError("\u4E0D\u652F\u6301\u7684\u97F3\u7B26: "+a[0])},parseAccidental(a,b){if(!a)return b;const c=a.substring(1).match(this.startsWithNumberRegex);let d=c?.[1];if(d=d?parseInt(d):1,0<=d){switch(a[0]){case"+":d*=12;break;case"-":d*=-12;break;case"b":d=-d;}return this.parseAccidental(c?.[2],b+d)}throw RangeError("\u4E0D\u652F\u6301\u7684\u5347\u964D\u8C03: "+a)}};return function(b){const c=a.checkMusicSyntax(a.removeComment(b)),d=c.keyNote;let e=d.charCodeAt(0)-l.CHAR_A-2;switch(0>e&&(e+=7),e=m.basicNoteTo12TET(e),d[1]){case"#":e++;break;case"b":e--;}const f=new g;return f.keyNote=e,f.bpm=c.bpm,f.beats=c.beats.split(",").filter(a=>a).map(b=>a.parseBeat(b)),f}},j.formatters=Object.freeze(Object.keys(o)),k.parsers=Object.freeze(Object.keys(p)),a.MusicFormatter||(a.MusicFormatter=j),a.MusicParser||(a.MusicParser=k),"undefined"!=typeof module&&module.exports&&(module.exports={MusicFormatter:a.MusicFormatter,MusicParser:a.MusicParser})})(this||{});